---
// server
import { getJSDocAugmentsTag } from "typescript";
import Home from "../components/Home";
import Layout from "../layouts/Layout.astro";
import prisma from "../lib/prisma";
import { getGame, getUserWithAllCodes } from "../lib/user";

const user = Astro.cookies.get("session")?.value;
let temp;

try {
  const game = await prisma.games.findFirst();
  await prisma.finalFound.findFirstOrThrow({
    where: {
      alias: {
        externalId: user,
      },
    },
  });
  const finalQuestion = await prisma.finalQuestion.findFirst();
  temp =
    game?.canFindFinalQuestion && finalQuestion
      ? {
          externalId: finalQuestion.externalId,
          assignment: finalQuestion.assignment,
          codeLength: finalQuestion.code.length,
        }
      : undefined;
} catch (e) {}

let you;
let game;
if (user) {
  you = await getUserWithAllCodes(user);
  game = await getGame();
}
---

<Layout>
  <Home you={you} finalQuestion={temp} game={game} client:load />
</Layout>
